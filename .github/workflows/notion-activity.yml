name: Log commits to Notion

on:
  push:
    branches:
      - main
      - master

jobs:
  log_to_notion:
    runs-on: ubuntu-latest
    steps:
      - name: Send commit(s) to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY}"
          COMMITS='${{ toJson(github.event.commits) }}'

          echo "$COMMITS" | jq -c '.[]' | while read -r c; do
            MSG=$(echo "$c" | jq -r '.message' | head -c 180)
            URL=$(echo "$c" | jq -r '.url')
            SHA=$(echo "$c" | jq -r '.id')
            AUTHOR=$(echo "$c" | jq -r '.author.name')
            TS=$(echo "$c" | jq -r '.timestamp')

            curl -sS https://api.notion.com/v1/pages \\
              -H "Authorization: Bearer $NOTION_TOKEN" \\
              -H "Notion-Version: 2022-06-28" \\
              -H "Content-Type: application/json" \\
              --data "{
                \\"parent\\": { \\"database_id\\": \\"$NOTION_DB_ID\\" },
                \\"properties\\": {
                  \\"Title\\": { \\"title\\": [{ \\"text\\": { \\"content\\": \\"$MSG\\" } }] },
                  \\"Repo\\": { \\"rich_text\\": [{ \\"text\\": { \\"content\\": \\"$REPO\\" } }] },
                  \\"SHA\\": { \\"rich_text\\": [{ \\"text\\": { \\"content\\": \\"$SHA\\" } }] },
                  \\"URL\\": { \\"url\\": \\"$URL\\" },
                  \\"Author\\": { \\"rich_text\\": [{ \\"text\\": { \\"content\\": \\"$AUTHOR\\" } }] },
                  \\"Timestamp\\": { \\"date\\": { \\"start\\": \\"$TS\\" } },
                  \\"Type\\": { \\"select\\": { \\"name\\": \\"commit\\" } }
                }
              }" >/dev/null
          done
